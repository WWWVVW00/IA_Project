<!DOCTYPE html>
<html>

<head>
  <title>影片檢測</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- js -->
  <link rel="stylesheet" href="static/css/index.css" type="text/css">

  <!-- css -->
  <script src="static/js/script.js" type="text/javascript"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Madimi+One&display=swap" rel="stylesheet">

  <!-- import Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    .container {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .video-container {
      flex: 1;
      margin-right: 20px;
    }

    .list-container {
      width: 600px;
    }

    .detection-list {
      list-style-type: none;
      padding: 0;
    }

    .detected {
      background-color: green;
      color: white;
      padding: 10px;
      margin: 5px 0;
    }

    .not-detected {
      background-color: gray;
      color: white;
      padding: 10px;
      margin: 5px 0;
    }

    #live-video {
      width: 100%;
      max-width: 1200px;
    }

    #loading-message {
      text-align: center;
      font-size: 18px;
    }
  </style>
</head>

<body>
  <div>
    <div id="header">
      <span style="font-size: 30px; cursor: pointer" onclick="openMenu()">
        &#9776;
      </span>
    </div>
    <div class="setMenu" id="menu">
      <a href="javascript:void(0)" class="close" onclick="closeMenu()">&times;</a>
      <a href="{{ url_for('index') }}">首頁</a>
      <a href="{{ url_for('liveDetect') }}">實時檢測</a>
      <a href="{{ url_for('uploadVideo') }}">影片檢測</a>
      <a href="{{ url_for('objectDetection') }}">圖像檢測</a>
    </div>

    <br />
    <br />
    <br />
    <br />

    <div style="text-align: center;">
      <h1>影片檢測</h1>

      <br />

      <div id="loading-message">
        <h2>請上傳所需檢測的<u><b><i>影片</i></b></u></h2>
        <form action="{{ url_for('vidpred') }}" method="post" enctype="multipart/form-data">
          <input type="file" name="video" accept="video/*" required>
          <button type="submit" id="upload-button" onclick="hide_button()">上傳</button>
        </form>
      </div>

      <div id="loading-spinner" style="display: none; text-align: center;">
        <p>Loading, please wait...</p>
      </div>

      {% if filename %}
      <div class="container d-flex">
        <div class="video-container">
          <img id="upload-video" src="{{ url_for('video_feed', filename=filename) }}" onload="hide_word()">
          <button type="button" id="stop" onclick="stopUpload()">停止</button>
        </div>
        <div class="list-container">
          <ul id="detection-list" class="detection-list text-center">
            <li data-item="stone" class="not-detected">rock</li>
            <li data-item="dirt" class="not-detected">dict</li>
            <li data-item="Person" class="not-detected">Person</li>
            <li data-item="wet" class="not-detected">Wet detected</li>
            <li data-item="Other-truck" class="not-detected">Car</li>
          </ul>
          <div id="yes-no-container" class="text-center">
            <div id="yes-no-box" class="not-detected">No</div>
          </div>
        </div>
      </div>

      <script>
        function hide_word() {
          const loadingMessage = document.getElementById('loading-message');
          loadingMessage.style.display = 'none';
        }

        function stop() {
          var video = document.getElementById("stop");
          video.load();
        }

        function hide_button() {
          const loadingbutton = document.getElementById('upload-button');
          loadingbutton.style.display = 'none'; // Use loadingbutton here
        }

        document.getElementById('upload-button').addEventListener('click', function () {
          this.disabled = true;  // Disable the button
          this.style.display = 'none';  // Hide the button
          showLoading();  // Show loading spinner
        });

        document.querySelector('form').addEventListener('submit', function () {
          showLoading();
        });

        function updateDetectionStatus(detectedItems) {
          const items = document.querySelectorAll('#detection-list li');
          const yesNoBox = document.getElementById('yes-no-box');

          items.forEach(item => {
            const itemName = item.getAttribute('data-item');
            if (detectedItems.includes(itemName)) {
              item.classList.remove('not-detected');
              item.classList.add('detected');
            } else {
              item.classList.remove('detected');
              item.classList.add('not-detected');
            }
          });

          if (detectedItems.includes('wet')) {
            yesNoBox.textContent = "No";
            yesNoBox.classList.remove('not-detected');
            yesNoBox.classList.add('detected');
            yesNoBox.style.backgroundColor = 'red';
            yesNoBox.style.color = 'white';
          } else {
            yesNoBox.textContent = "Yes";
            yesNoBox.classList.remove('detected');
            yesNoBox.classList.add('not-detected');
            yesNoBox.style.backgroundColor = 'green';
            yesNoBox.style.color = 'white';
          }
        }

        setInterval(() => {
          fetch('/videos-detect')
            .then(response => response.json())
            .then(data => {
              const detectedItems = data.detected_items;
              updateDetectionStatus(detectedItems);
              hideLoading();  // Hide loading spinner after fetching the data
            })
            .catch(error => {
              console.error('Error fetching detection data:', error);
              hideLoading();  // Hide loading spinner in case of error
            });
        }, 5000);
      </script>
    </div>

    {% endif %}

    <footer class="bg-dark py-4 mt-auto">
      <div class="text-center justify-content-between flex-column flex-sm-row">
        <div class="small m-0 text-white"> &copy;Chun Wo Construction and Engineering Co. Ltd. </div>
      </div>
    </footer>
</body>

</html>